<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-91362999-4"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-91362999-4');
    </script>
    <link rel="shortcut icon" href="/img/favicon.ico" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/base16/material-palenight.min.css"
    />
    <link rel="stylesheet" href="../css/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta
      name="description"
      content="Learn how to create an email auto-responder for Gmail using Google Apps Script."
    />
    <meta
      property="og:title"
      content="Create an email auto-responder with Apps Script"
    />
    <meta
      property="og:image"
      content="//benronkin.com/img/auto-responder-gmail.png"
    />
    <meta
      property="og:description"
      content="Learn how to create an email auto-responder for Gmail using Google Apps Script."
    />
    <meta
      property="og:url"
      content="//benronkin.com/blog/create-email-auto-responder-with-apps-script.html"
    />
    <title>Create an email auto-responder with Apps Script | Ben Ronkin</title>
  </head>

  <body>
    <main>
      <nav>
        <div class="nav-wrapper">
          <a href="../index.html" class="brand-logo" style="margin-left: 20px"
            >Ben Ronkin</a
          >
          <a href="#" data-target="mobile" class="sidenav-trigger"
            ><i class="material-icons black-text">menu</i></a
          >
          <ul class="sidenav" id="mobile">
            <li><a href="../products/index.html">Shop scripts</a></li>
            <li><a href="../portfolio/index.html">Case studies</a></li>
            <li><a href="../reviews.html">Client reviews</a></li>
            <li><a href="./index.html">Blog</a></li>
            <li><a href="../contact.html">Contact</a></li>
          </ul>
          <ul id="nav-mobile" class="right hide-on-med-and-down">
            <li data-tooltip="Work">
              <a href="../products/index.html">SHOP</a>
            </li>
            <li data-tooltip="Work">
              <a href="../portfolio/index.html">CASE STUDIES</a>
            </li>
            <li data-tooltip="Client Testimonials">
              <a href="../reviews.html">REVIEWS</a>
            </li>
            <li data-tooltip="Blog">
              <a href="../blog/index.html"> BLOG</a>
            </li>
            <li data-tooltip="Contact">
              <a href="../contact.html"> CONTACT</a>
            </li>
          </ul>
        </div>
      </nav>

      <div class="container">
        <div class="blog-post">
          <div class="blog-post-header">
            <h5><a href="index.html">Blog</a></h5>
            <h1>Create an email auto-responder with Apps Script</h1>
            <p class="muted">
              <span style="display: flex; align-items: center">
                <i class="material-icons">today</i> November 18, 2022
              </span>
            </p>
          </div>

          <div
            class="blog-post-hero"
            style="display: flex; justify-content: center"
          >
            <iframe
              width="560"
              height="315"
              src="https://www.youtube.com/embed/2UO7XnIoErI
              "
              title="YouTube video player"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
            ></iframe>
          </div>

          <div class="blog-post-body">
            <p>
              Having a system that automatically responds to incoming email
              messages can be a great time saver. In this post you will learn
              how to create such a system for Gmail, using Google Apps Script.
            </p>
            <h3>Business requirements</h3>
            <p>
              When designing the solution, I've had the following business
              requirements:
            </p>
            <ul>
              <li>
                Create a trigger to have the script run automatically every
                minute
              </li>
              <li>Make it easy to define what kinds of emails to respond to</li>
              <li>
                Ensure that emails don't get duplicate replies even if they
                remain in the inbox
              </li>
              <li>Log how many emails received a reply in every run</li>
            </ul>
            <div class="row mt30 mb0">
              <div class="col s12 prompt">
                <span> Interested in customizing this script? </span>
                <a class="ml20" href="../contact.html"> Contact me</a>
              </div>
            </div>
            <h3>The script</h3>
            <p>
              You can download the complete script
              <a
                href="https://gist.github.com/benronkin/1acd4afbee62e3b37a634ef0016c548f"
                target="_blank"
                >from here</a
              >. For those who want more information, I will go through the code
              below.
            </p>
            <p>
              The first thing I like to do is to create a global config object
              that is used to keep some definitions that are used throughout the
              script. I place the object at the top of the file, which will make
              it easy for you to find the definitions and change them as needed.
            </p>
            <pre><code>// Manage script configuration here
const g = {
  subjectFilter: 'New inquiry',
  labelName: 'Auto-replied',
  textBody: `Hi,

  Thank you for contacting us. This is an auto-response system. 
  One of our agents will contact you shortly.`,
  htmlBody: `&lt;p&gt;Hi,&lt;/p&gt;

  &lt;p&gt;Thank you for contacting us. This is an auto-response system. 
  One of our agents will contact you shortly.&lt;/p&gt;`,
  maxThreads: 100,
  startingThread: 0,
  replyCount: 0,
};</code></pre>
            <p>
              <code>g</code> is the global object.
              <code>subjectFilter</code> contains the subject keywords that the
              script should respond to. In other words, the script will reply
              only to emails whose subject line contains these keywords.
            </p>
            <p>
              <code>labelName</code> is the Gmail label that the script assigns
              to the replied email. We use the label name alongside
              <code>subjectFilter</code> to focus only on new emails. This will
              prevent sending duplicate replies to each email.
            </p>
            <p>
              <code>textBody</code> and <code>htmlBody</code> contain the texts
              that the script will inject into the reply.
            </p>
            <p>
              The next two keys have to do with handling many threads. Google
              Apps Script has a limit on the number of email threads that can be
              fetched at one time. If we have a lot of threads then we need to
              pull them in several requests, by paging through them, like paging
              through search results. <code>maxThreads</code> specifies how many
              threads to pull at one time, and <code>startingThread</code> is
              akin to a page number: fetch from thread zero, then from thread
              one hundred, and so on.
            </p>
            <p>
              Lastly, <code>replyCount</code> sums up the number of emails that
              receive a reply.
            </p>
            <h3>Initializing the automation</h3>
            <p>
              Every time the script runs, it performs an initialization for the
              entire automation. Here's the code for that:
            </p>
            <pre><code>function init_() {
  const labels = GmailApp.getUserLabels().map((l) => l.getName());
  if (!labels.includes(g.labelName)) {
    GmailApp.createLabel(g.labelName);
  }
  g.label = GmailApp.getUserLabelByName(g.labelName);
  const queryFilter = {
    subject: g.subjectFilter,
    '-label': g.labelName,
  };
  g.query = Object.entries(queryFilter)
    .map((e) => e.join(':'))
    .join(' ');
  const triggers = ScriptApp.getProjectTriggers();
  if (triggers.length == 0) {
    ScriptApp.newTrigger('checkAndReply')
      .timeBased().everyMinutes(1).create();
  }
}</code></pre>

            <p>
              First, the script checks if Gmail already has a user-generated
              label of the name defined in <code>g.labelName</code>. If it
              doesn't then it creates a label, and stores a reference to it in
              <code>g.label</code>.
            </p>
            <p>
              Next, we define a filter to limit the scope of the threads we want
              Gmail to search for. We want threads with subject lines that
              contain our key words, as well as threads that haven't been
              labeled with our label. <code>g.query</code> takes the keys and
              values of the <code>queryFilter</code> object and joins them into
              a string that GmailApp.search can use.
            </p>
            <p>
              Finally, we want this script to run automatically every minute. To
              do so, we check whether the script already has a trigger (from a
              prior run), and if not, then we create one.
            </p>
            <div>
              <img
                class="responsive-img"
                src="../img/auto-responder-trigger.png"
                alt="Auto responder trigger"
              />
            </div>
            <h3>The main body</h3>
            <p>
              Now we get to the main part of the automation: checking for new
              emails, replying to them, and labeling them to avoid duplicate
              replies.
            </p>
            <p>
              First, we declare the main function that the trigger will run and
              execute the initialization.
            </p>
            <pre><code>function checkAndReply(){
  init_();
}</code></pre>
            <p>
              Next, we create a loop to iterate through the threads. We ask
              GmailApp to search for threads that meet our filtering criteria,
              starting at a specific thread number and retrieving our maximum
              threads threshold.
            </p>
            <p>
              We increment our starting thread number by the maximum threads,
              and we check if the number of returned threads is less than our
              maximum threads count. If it is then that's our sign that there
              are no more threads to page through and we break out of the loop.
            </p>
            <pre><code>function checkAndReply() {
  init_();
  while (true) {
    const threads = GmailApp.search(g.query, g.startingThread, g.maxThreads);
    g.startingThread += g.maxThreads;
    if (threads.length < g.maxThreads) {
      break;
    }
  }
}</code></pre>
            <p>
              Next, we handle each of the returned threads separately. We reply
              to it using our text strings, and then label the thread. We also
              increment the count of emails we've replied to.
            </p>
            <pre><code>threads.forEach((thread) => {
  thread.reply(g.textBody, { htmlBody: g.htmlBody });
  g.label.addToThread(thread);
  g.replyCount++;
});</code></pre>
            <p>
              The final piece is to log out the number of emails replies we sent
              this time around:
            </p>
            <pre><code>const text =
  g.replyCount == 0
    ? 'No new emails found.'
    : g.replyCount == 1
    ? 'Replied to one new email.'
    : `Replied to ${g.replyCount} new emails.`;
console.log(text);</code></pre>
            <h3>Further customization</h3>
            <p>
              Again, you can download the complete script
              <a
                href="https://gist.github.com/benronkin/1acd4afbee62e3b37a634ef0016c548f"
                target="_blank"
                >from here</a
              >. The script can be easily modified to handle more complex logic.
              You could, for instance:
            </p>
            <ul>
              <li>Create an out-of-office responder for nights and weekends</li>
              <li>
                Use different reply texts for different emails based on some
                business criteria, such as subject keywords or sender
                information
              </li>
              <li>
                Store the text in Google Docs so that non-developers can modify
                the replies without handling the code
              </li>
              <li>
                Log the transactions to a Google Sheet for more in-depth
                analysis
              </li>
            </ul>

            <div class="row mt30 mb0">
              <div class="col s12 prompt">
                <span> Interested in customizing this script? </span>
                <a class="ml20" href="../contact.html"> Contact me</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="page-footer">
      <div class="footer-copyright">
        <div class="container space-between">
          <span>© 2020-2023 Copyright Ben Ronkin</span>
        </div>
      </div>
    </footer>

    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
    <script src="../js/main.js"></script>
  </body>
</html>
